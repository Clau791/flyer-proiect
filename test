# Folosim modelul de bazÄƒ (asigurÄƒ-te cÄƒ ai tras aya-expanse:32b sau similar)
FROM aya-expanse:32b

# PARAMETRI CRITICI PENTRU SUBTITRÄ‚RI

# 1. Context Window (Foarte important pentru "flow")
# Default e 2048. La 8192, modelul È›ine minte ultimele ~5-10 minute de dialog.
# RTX 5090 are VRAM destul pentru asta.
PARAMETER num_ctx 8192

# 2. Creativitate controlatÄƒ
# 0.1 e prea robotic (traduce cuvÃ¢nt cu cuvÃ¢nt).
# 0.3 este "sweet spot-ul" pentru Aya la traduceri naturale.
PARAMETER temperature 0.3

# 3. Penalizare repetiÈ›ie
# Previne blocajele, dar nu e prea agresiv (1.1 e safe).
PARAMETER repeat_penalty 1.1

# 4. ProbabilitÄƒÈ›i
PARAMETER top_k 40
PARAMETER top_p 0.9

# SYSTEM PROMPT (Identitatea modelului)
# Aici Ã®i spunem "hardcoded" sÄƒ nu traducÄƒ robotic.
SYSTEM """
You are a professional subtitle translator specializing in Romanian.
Your primary goal is NARRATIVE FLOW and COHERENCE.

RULES:
1. Translate MEANING, not just words.
2. If a sentence is split across segments, ensure the grammar connects logically.



# 3) ðŸ†• POST-PROCESARE ÃŽN BATCH-URI (DUBLÄ‚ RAFINARE)
        # SeteazÄƒ BATCH_SIZE mai mare direct Ã®n instanÈ›Äƒ Ã®nainte de rulare
        self._refiner.BATCH_SIZE = 30  # MÄƒrit de la 10 la 30 pentru RTX 5090
        
        print(f"[SUBTITLE] Rafinare Pasul 1 (Context & Flow) - Batch size 30...")
        
        # PASUL 1: Rafinare primarÄƒ
        refined_pass_1 = self._run_stage(
            "rafinare_1",
            expected_seconds=timeline["refine"],
            base_percent=pct_transcribe + pct_translate,
            weight_percent=pct_refine / 2, # ÃŽmpÄƒrÈ›im timpul estimat
            func=lambda: self._refine_translations_in_batches(
                segments, translated_texts, originals, target_lang=lang, mode=translator_mode
            ),
        )

        # PASUL 2: Rafinare secundarÄƒ (Polish)
        # Trimitem rezultatul din Pasul 1 ca input pentru Pasul 2
        print(f"[SUBTITLE] Rafinare Pasul 2 (Extra Polish & Style)...")
        
        refined_translations = self._run_stage(
            "rafinare_2",
            expected_seconds=timeline["refine"],
            base_percent=pct_transcribe + pct_translate + (pct_refine / 2),
            weight_percent=pct_refine / 2,
            func=lambda: self._refine_translations_in_batches(
                segments, refined_pass_1, originals, target_lang=lang, mode=translator_mode
            ),
        )
        
        print(f"[SUBTITLE] Dubla rafinare OK: {len(refined_translations)} segmente")
3. Use natural, spoken Romanian (avoid "translationese").
4. Keep subtitles concise (max 42 chars/line).
5. Never output explanations, only the translation.
"""
